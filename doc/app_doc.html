<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>app.py 라우트 및 구조 설명</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; padding: 2rem; background: #f9f9f9; line-height: 1.6; }
    h1, h2 { color: #2c3e50; }
    h2 { margin-top: 2rem; }
    code, pre { background: #eee; padding: 4px 6px; border-radius: 4px; }
    .route { background: #fff; padding: 1rem; border-left: 5px solid #007acc; margin-bottom: 1.5rem; border-radius: 6px; }
    .desc { margin-bottom: 0.5rem; }
    ul { margin-top: 0.4rem; }
  </style>
</head>
<body>

  <h1>🚀 <code>app.py</code> Flask 서버 구조 설명</h1>
  <p>이 파일은 AI 캘린더 비서 서버의 메인 엔트리로, 인증, 일정 조회, GPT 처리 등의 HTTP API 엔드포인트를 정의합니다.</p>

  <h2>📦 초기 설정</h2>
  <ul>
    <li><code>Flask</code> 앱 초기화 및 시크릿 키 설정</li>
    <li><code>.env</code> 로딩 및 디버깅용 출력</li>
    <li><code>ProxyFix</code>로 HTTPS 프로토콜 호환성 확보</li>
  </ul>

  <h2>🔐 <code>check_env_vars()</code></h2>
  <p>필수 환경 변수가 모두 설정되어 있는지 확인하는 함수입니다.</p>

  <div class="route">
    <h2>📍 <code>GET /</code></h2>
    <p class="desc">서버 기본 응답. 상태 확인용 루트 엔드포인트입니다.</p>
  </div>

  <div class="route">
    <h2>📍 <code>GET /auth_status</code></h2>
    <p class="desc">특정 사용자(user_id)의 Google Calendar 인증 상태를 확인합니다.</p>
    <ul>
      <li>환경 변수 체크 포함</li>
      <li>Redis에 토큰 존재 여부로 인증 여부 판단</li>
    </ul>
  </div>

  <div class="route">
    <h2>📍 <code>GET /calendar</code></h2>
    <p class="desc">사용자의 일정 정보를 조회하는 API입니다.</p>
    <ul>
      <li>필수 파라미터: <code>start_date</code>, <code>end_date</code>, <code>user_id</code></li>
      <li>캘린더 서비스 객체 생성 → 일정 조회 후 JSON 반환</li>
    </ul>
  </div>

  <div class="route">
    <h2>📍 <code>POST /query_calendar</code></h2>
    <p class="desc">날짜 범위를 JSON으로 전달받아 일정을 조회합니다.</p>
    <ul>
      <li>JSON body: <code>start_time</code>, <code>end_time</code>, <code>user_id</code></li>
      <li>유효성 검사 및 ISO 8601 → datetime 변환 처리</li>
    </ul>
  </div>

  <div class="route">
    <h2>📍 <code>GET /login</code></h2>
    <p class="desc">OAuth 로그인 시작 라우트입니다.</p>
    <ul>
      <li><code>AuthManager</code>를 통해 인증 URL 생성</li>
      <li>사용자를 Google 인증 페이지로 리디렉션</li>
    </ul>
  </div>

  <div class="route">
    <h2>📍 <code>GET /oauth2callback</code></h2>
    <p class="desc">OAuth 인증 완료 후 Google에서 리디렉션되는 콜백 URL입니다.</p>
    <ul>
      <li>Access Token 받아오기 + 사용자 이메일 추출</li>
      <li>Redis에 토큰 저장 및 인증 완료 로그 출력</li>
    </ul>
  </div>

  <div class="route">
    <h2>📍 <code>GET /logout</code></h2>
    <p class="desc">Redis에서 토큰을 삭제하여 로그아웃을 수행합니다.</p>
    <ul>
      <li><code>tokens:{platform}:{user_id}</code> 키 삭제</li>
      <li>사용자 인증 해제</li>
    </ul>
  </div>

  <div class="route">
    <h2>📍 <code>POST /ask_gpt</code></h2>
    <p class="desc">GPT를 통해 자연어로 일정 질문에 응답하는 기능입니다.</p>
    <ul>
      <li>입력: <code>query</code>, <code>user_id</code>, (선택) <code>platform</code></li>
      <li><code>gpt_calendar.py</code>의 <code>process_calendar_query()</code> 호출</li>
      <li>일정 설명 요약 + GPT 응답 메시지 생성</li>
    </ul>
  </div>

  <div class="route">
    <h2>📍 <code>GET /debug_session</code></h2>
    <p class="desc">세션 디버깅용 라우트 (개발 시에만 사용).</p>
  </div>

  <h2>⚙️ 실행</h2>
  <pre><code>if __name__ == '__main__':
    app.run(host='0.0.0.0', port=PORT, debug=False)</code></pre>
  <p>Google Cloud Run 같은 환경에서는 <code>PORT</code> 환경 변수를 자동으로 사용합니다.</p>

</body>
</html>
